!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@angular/core"),require("rxjs/internal/Subject"),require("@angular/common")):"function"==typeof define&&define.amd?define("ngx-tetris",["exports","@angular/core","rxjs/internal/Subject","@angular/common"],n):n(e["ngx-tetris"]={},e.ng.core,e.rxjs["internal/Subject"],e.ng.common)}(this,function(e,i,n,t){"use strict";var d=function(e,n){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var i in n)n.hasOwnProperty(i)&&(e[i]=n[i])})(e,n)};function r(e,n){function i(){this.constructor=e}d(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}function o(e,n){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var t,d,r=i.call(e),o=[];try{for(;(void 0===n||0<n--)&&!(t=r.next()).done;)o.push(t.value)}catch(u){d={error:u}}finally{try{t&&!t.done&&(i=r["return"])&&i.call(r)}finally{if(d)throw d.error}}return o}function u(){for(var e=[],n=0;n<arguments.length;n++)e=e.concat(o(arguments[n]));return e}var s={DEG_0:0,DEG_90:1,DEG_180:2,DEG_270:3};s[s.DEG_0]="DEG_0",s[s.DEG_90]="DEG_90",s[s.DEG_180]="DEG_180",s[s.DEG_270]="DEG_270";var f={Dot:1,Box:2,Line:3,T:4,L:5,Lr:6,Z:7,S:8};f[f.Dot]="Dot",f[f.Box]="Box",f[f.Line]="Line",f[f.T]="T",f[f.L]="L",f[f.Lr]="Lr",f[f.Z]="Z",f[f.S]="S";var a="color-box",h="color-dot",c="color-line",l="color-t",p="color-l",_="color-lr",g="color-z",m="color-s",v=function(){function e(e,n,i,t){this.color="red",this.rotation=s.DEG_0,this.map=[[],[]],this._lastConfig=null,this._gridSize=i,this.x=e,this.y=n,this._maps=t,this.map=this._maps[this.rotation]}return Object.defineProperty(e.prototype,"positionsOnGrid",{get:function(){for(var e=[],n=0;n<4;n++)for(var i=0;i<4;i++)if(this.map[n][i]){var t=(this.y+n)*this._gridSize.width+this.x+i;0<t&&e.push(t)}return e},enumerable:!0,configurable:!0}),e.prototype.store=function(){this._lastConfig={x:this.x,y:this.y,rotation:this.rotation,map:this.map}},e.prototype.clearStore=function(){this._lastConfig=null},e.prototype.revert=function(){if(this._lastConfig){for(var e in this._lastConfig)this._lastConfig.hasOwnProperty(e)&&(this[e]=this._lastConfig[e]);this._lastConfig=null}},e.prototype.rotate=function(){var e=Object.keys(this._maps),n=e.indexOf(this.rotation.toString());n>=e.length-1?this.rotation=e[0]:this.rotation=e[++n],this.map=this._maps[this.rotation]},e.prototype.moveDown=function(){this.y++},e.prototype.moveRight=function(){this.x++},e.prototype.moveLeft=function(){this.x--},Object.defineProperty(e.prototype,"bottomRow",{get:function(){return this.y+3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rightCol",{get:function(){for(var e=3;0<=e;){for(var n=0;n<=3;n++)if(this.map[n][e])return this.x+e;e--}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"leftCol",{get:function(){return this.x},enumerable:!0,configurable:!0}),e}(),y=[];y[s.DEG_0]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[f.Box,undefined,undefined,undefined]];var b=function(d){function e(e,n,i){var t=d.call(this,e,n,i,y)||this;return t.color=h,t}return r(e,d),e}(v),S=[];S[s.DEG_0]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[f.Box,f.Box,undefined,undefined],[f.Box,f.Box,undefined,undefined]];var L=function(d){function e(e,n,i){var t=d.call(this,e,n,i,S)||this;return t.color=a,t}return r(e,d),e}(v),w=[];w[s.DEG_0]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[f.Line,f.Line,f.Line,f.Line]],w[s.DEG_90]=[[f.Line,undefined,undefined,undefined],[f.Line,undefined,undefined,undefined],[f.Line,undefined,undefined,undefined],[f.Line,undefined,undefined,undefined]];var D=function(d){function e(e,n,i){var t=d.call(this,e,n,i,w)||this;return t.color=c,t}return r(e,d),e}(v),P={};P[s.DEG_0]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[undefined,f.T,undefined,undefined],[f.T,f.T,f.T,undefined]],P[s.DEG_90]=[[undefined,undefined,undefined,undefined],[f.T,undefined,undefined,undefined],[f.T,f.T,undefined,undefined],[f.T,undefined,undefined,undefined]],P[s.DEG_180]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[f.T,f.T,f.T,undefined],[undefined,f.T,undefined,undefined]],P[s.DEG_270]=[[undefined,undefined,undefined,undefined],[undefined,f.T,undefined,undefined],[f.T,f.T,undefined,undefined],[undefined,f.T,undefined,undefined]];var E=function(d){function e(e,n,i){var t=d.call(this,e,n,i,P)||this;return t.color=l,t}return r(e,d),e}(v),G={};G[s.DEG_0]=[[undefined,undefined,undefined,undefined],[undefined,f.Z,undefined,undefined],[f.Z,f.Z,undefined,undefined],[f.Z,undefined,undefined,undefined]],G[s.DEG_90]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[f.Z,f.Z,undefined,undefined],[undefined,f.Z,f.Z,undefined]];var O=function(d){function e(e,n,i){var t=d.call(this,e,n,i,G)||this;return t.color=g,t}return r(e,d),e}(v),C={};C[s.DEG_0]=[[undefined,undefined,undefined,undefined],[f.S,undefined,undefined,undefined],[f.S,f.S,undefined,undefined],[undefined,f.S,undefined,undefined]],C[s.DEG_90]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[undefined,f.S,f.S,undefined],[f.S,f.S,undefined,undefined]];var x=function(d){function e(e,n,i){var t=d.call(this,e,n,i,C)||this;return t.color=m,t}return r(e,d),e}(v),z={};z[s.DEG_0]=[[undefined,undefined,undefined,undefined],[f.L,undefined,undefined,undefined],[f.L,undefined,undefined,undefined],[f.L,f.L,undefined,undefined]],z[s.DEG_90]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[f.L,f.L,f.L,undefined],[f.L,undefined,undefined,undefined]],z[s.DEG_180]=[[undefined,undefined,undefined,undefined],[f.L,f.L,undefined,undefined],[undefined,f.L,undefined,undefined],[undefined,f.L,undefined,undefined]],z[s.DEG_270]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[undefined,undefined,f.L,undefined],[f.L,f.L,f.L,undefined]];var k=function(d){function e(e,n,i){var t=d.call(this,e,n,i,z)||this;return t.color=p,t}return r(e,d),e}(v),I={};I[s.DEG_0]=[[undefined,undefined,undefined,undefined],[f.Lr,f.Lr,undefined,undefined],[undefined,f.Lr,undefined,undefined],[undefined,f.Lr,undefined,undefined]],I[s.DEG_90]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[undefined,undefined,f.Lr,undefined],[f.Lr,f.Lr,f.Lr,undefined]],I[s.DEG_180]=[[undefined,undefined,undefined,undefined],[f.Lr,undefined,undefined,undefined],[f.Lr,undefined,undefined,undefined],[f.Lr,f.Lr,undefined,undefined]],I[s.DEG_270]=[[undefined,undefined,undefined,undefined],[undefined,undefined,undefined,undefined],[f.Lr,f.Lr,f.Lr,undefined],[f.Lr,undefined,undefined,undefined]];var R=function(d){function e(e,n,i){var t=d.call(this,e,n,i,I)||this;return t.color=_,t}return r(e,d),e}(v),T=function(){function e(e){this._available=[],this._gridSize=e,this._available.push(b),this._available.push(L),this._available.push(D),this._available.push(E),this._available.push(O),this._available.push(x),this._available.push(k),this._available.push(R)}return e.prototype.getRandomPiecePiece=function(e,n){var i=Math.floor(Math.random()*this._available.length);return new this._available[i](e,n,this._gridSize)},e}(),j=function V(){this.solid=!1,this.color=null},B=function(){function e(){this.settings={tileSize:null},this._gridSize={width:0,height:0},this._locked=!0,this._lineCleared=new n.Subject,this._gameOver=new n.Subject,this.lineCleared$=this._lineCleared.asObservable(),this.gameOver$=this._gameOver.asObservable()}return Object.defineProperty(e.prototype,"elementsInRow",{get:function(){return this._gridSize.width},enumerable:!0,configurable:!0}),e.prototype.initialize=function(e,n,i,t){this._gridSize.width=e,this._gridSize.height=n,this._gameSpeed=i,this._piecesFactory=new T(this._gridSize),t&&(this.settings.tileSize=t),this._initializeEmptyBoard(),this._spawnNewPiece(),this._drawPiece()},e.prototype.start=function(){var e=this;clearInterval(this._gameInterval),this._gameInterval=setInterval(function(){e._update()},this._gameSpeed),this._locked=!1},e.prototype.stop=function(){this._locked=!0,clearInterval(this._gameInterval)},e.prototype.reset=function(){for(var e=new j,n=0;n<this.grid.length;n++)(this.grid[n].color||this.grid[n].solid)&&this.__changeCell(n,e);this._spawnNewPiece(),this._drawPiece()},e.prototype.moveLeft=function(){this._locked||(this._clearPiece(),this._piece.store(),this._piece.moveLeft(),this._collidesLeft()&&this._piece.revert(),this._drawPiece())},e.prototype.moveRight=function(){this._locked||(this._clearPiece(),this._piece.store(),this._piece.moveRight(),this._collidesRight()&&this._piece.revert(),this._drawPiece())},e.prototype.rotate=function(){if(!this._locked){for(this._clearPiece(),this._piece.store(),this._piece.rotate();this._collidesRight();)if(this._piece.moveLeft(),this._collidesLeft()){this._piece.revert();break}this._drawPiece()}},e.prototype.moveDown=function(){this._update()},e.prototype._clearFullLines=function(){for(var e=this._gridSize.height-1;0<=e;e--){for(var n=!0,i=0;i<this._gridSize.width;i++){var t=e*this._gridSize.width+i;if(!1===this.grid[t].solid){n=!1;break}}if(n){var d=Array.apply(null,Array(this._gridSize.width)).map(function(e){return new j}),r=this.grid.slice(0,e*this._gridSize.width);(o=this.grid).splice.apply(o,u([0,++e*this._gridSize.width],d.concat(r))),this._lineCleared.next()}}var o},e.prototype._update=function(){this._locked||(this._locked=!0,this._piece.revert(),this._clearPiece(),this._piece.store(),this._piece.moveDown(),this._collidesBottom()&&(this._piece.revert(),this._markSolid(),this._drawPiece(),this._clearFullLines(),this._spawnNewPiece(),this._isGameOver())?this._onGameOver():(this._drawPiece(),this._locked=!1))},e.prototype._isGameOver=function(){return this._piece.store(),this._piece.moveDown(),!!this._collidesBottom()||(this._piece.revert(),!1)},e.prototype._onGameOver=function(){this.stop(),this._gameOver.next()},e.prototype._spawnNewPiece=function(){this._piece=this._piecesFactory.getRandomPiecePiece(4,-4)},e.prototype._initializeEmptyBoard=function(){var e=this._gridSize.width*this._gridSize.height;this.grid=Array.apply(null,Array(e)).map(function(e){return new j})},e.prototype._clearPiece=function(){var n=this;this._piece.positionsOnGrid.forEach(function(e){n.__changeCell(e,{color:undefined})})},e.prototype._drawPiece=function(){var n=this;this._piece.clearStore(),this._piece.positionsOnGrid.forEach(function(e){n.__changeCell(e,{color:n._piece.color})})},e.prototype._markSolid=function(){var n=this;this._piece.positionsOnGrid.forEach(function(e){n.__changeCell(e,{solid:!0})})},e.prototype.__changeCell=function(e,n){void 0===n&&(n={}),this.grid[e]=Object.assign({},this.grid[e],n)},e.prototype._collidesBottom=function(){return this._piece.bottomRow>=this._gridSize.height||this.__collides()},e.prototype._collidesLeft=function(){return this._piece.leftCol<0||this.__collides()},e.prototype._collidesRight=function(){return this._piece.rightCol>=this._gridSize.width||this.__collides()},e.prototype.__collides=function(){var n=this;return this._piece.positionsOnGrid.some(function(e){return!!(0<e&&n.grid[e]&&n.grid[e].solid)})},e.decorators=[{type:i.Injectable}],e.ctorParameters=function(){return[]},e}(),Z={Paused:0,Started:1,Over:2};Z[Z.Paused]="Paused",Z[Z.Started]="Started",Z[Z.Over]="Over";var M=function(){function e(e){var n=this;this._manager=e,this.rotate=!1,this.moveLeft=!1,this.moveRight=!1,this.moveDown=!1,this.start=!1,this.stop=!1,this.reset=!1,this.lineCleared=new i.EventEmitter,this.gameOver=new i.EventEmitter,this.state=Z.Paused,this.gridWidth=10,this.gridHeight=20,this._manager.lineCleared$.subscribe(function(e){return n._onLineCleared(e)}),this._manager.gameOver$.subscribe(function(e){return n._onGameOver(e)})}return e.prototype.ngOnInit=function(){var e=this;this.initialSpeed=this.initialSpeed||500,this._moveDownSpeed=.2*this.initialSpeed,this._manager.initialize(this.gridWidth,this.gridHeight,this.initialSpeed,this.tileSize),this.grid=this._manager.grid,setInterval(function(){e.moveDown&&e._manager.moveDown()},this._moveDownSpeed)},e.prototype.ngOnChanges=function(e){this._keyPressed(e.moveLeft)?this._manager.moveLeft():this._keyPressed(e.moveRight)&&this._manager.moveRight(),this._keyPressed(e.rotate)&&this._manager.rotate(),this._keyPressed(e.start)&&this._manager.start(),this._keyPressed(e.stop)&&this._manager.stop(),this._keyPressed(e.reset)&&this._manager.reset()},e.prototype.actionLeft=function(){this._manager.moveLeft()},e.prototype.actionRight=function(){this._manager.moveRight()},e.prototype.actionRotate=function(){this._manager.rotate()},e.prototype.actionDown=function(){this._manager.moveDown()},e.prototype.actionReset=function(){this._manager.reset()},e.prototype.actionStart=function(){this._manager.start(),this.state=Z.Started},e.prototype.actionStop=function(){this._manager.stop(),this.state=Z.Paused},e.prototype._keyPressed=function(e){return e&&e.currentValue&&!e.previousValue},e.prototype._onLineCleared=function(e){this.lineCleared.emit(e)},e.prototype._onGameOver=function(e){this.state=Z.Over,this.gameOver.emit()},e.decorators=[{type:i.Component,args:[{selector:"tetris-core",template:'<board\n    [grid]="grid"></board>\n'}]}],e.ctorParameters=function(){return[{type:B}]},e.propDecorators={tileSize:[{type:i.Input}],initialSpeed:[{type:i.Input}],rotate:[{type:i.Input}],moveLeft:[{type:i.Input}],moveRight:[{type:i.Input}],moveDown:[{type:i.Input}],start:[{type:i.Input}],stop:[{type:i.Input}],reset:[{type:i.Input}],lineCleared:[{type:i.Output}],gameOver:[{type:i.Output}]},e}(),A=function(){function e(e,n,i){this.el=e,this._renderer=n,this._manager=i,this.tileSize=null,this._manager.settings.tileSize&&(this.tileSize=this._manager.settings.tileSize)}return e.prototype.ngOnInit=function(){this.data.color&&this._renderer.addClass(this.el.nativeElement,this.data.color)},e.decorators=[{type:i.Component,args:[{selector:"tile",template:"",encapsulation:i.ViewEncapsulation.None,changeDetection:i.ChangeDetectionStrategy.OnPush,host:{"[style.width]":"tileSize","[style.height]":"tileSize"},styles:["tile{display:block;background:rgba(176,230,225,.35);width:25px;height:25px;float:left;border:1px solid #4e4645;margin:1px}tile.color-box{background:#fca}tile.color-dot{background:#ff77a8}tile.color-line{background:#83769c}tile.color-t{background:#29adff}tile.color-l{background:#00e436}tile.color-lr{background:#ffec27}tile.color-z{background:#ffa300}tile.color-s{background:#c2c3c7}"]}]}],e.ctorParameters=function(){return[{type:i.ElementRef},{type:i.Renderer2},{type:B}]},e.propDecorators={data:[{type:i.Input}]},e}(),N=function(){function e(e){this._manager=e,this.boardWidth=null}return e.prototype.ngAfterViewInit=function(){if(this._manager.settings.tileSize){var e=this.tile.el.nativeElement.getBoundingClientRect().width+2;this.boardWidth=e*this._manager.elementsInRow}},e.decorators=[{type:i.Component,args:[{selector:"board",template:'<tile *ngFor="let tileData of grid"\n    [data]="tileData">\n</tile>\n',host:{"[style.width]":'boardWidth + "px"'},styles:[":host{width:290px;display:block}"]}]}],e.ctorParameters=function(){return[{type:B}]},e.propDecorators={grid:[{type:i.Input}],tile:[{type:i.ViewChild,args:[A]}]},e}(),F=function(){function e(){}return e.forRoot=function(){return{ngModule:e}},e.decorators=[{type:i.NgModule,args:[{imports:[t.CommonModule],declarations:[M,N,A],providers:[B],exports:[M]}]}],e}();e.TetrisCoreModule=F,e.GameState=Z,e.TetrisCoreComponent=M,e.ɵb=N,e.ɵa=B,e.ɵc=A,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ngx-tetris.umd.min.js.map