/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { PiecesFactory } from '../classes/PiecesFactory';
import { Subject } from 'rxjs/internal/Subject';
/** @type {?} */
var SPAWN_POSITION_X = 4;
/** @type {?} */
var SPAWN_POSITION_Y = -4;
var Tile = /** @class */ (function () {
    function Tile() {
        this.solid = false;
        this.color = null;
    }
    return Tile;
}());
export { Tile };
if (false) {
    /** @type {?} */
    Tile.prototype.solid;
    /** @type {?} */
    Tile.prototype.color;
}
var GameManagerService = /** @class */ (function () {
    function GameManagerService() {
        this.settings = {
            tileSize: null
        };
        this._gridSize = { width: 0, height: 0 };
        this._locked = true;
        this._lineCleared = new Subject();
        this._gameOver = new Subject();
        this.lineCleared$ = this._lineCleared.asObservable();
        this.gameOver$ = this._gameOver.asObservable();
    }
    Object.defineProperty(GameManagerService.prototype, "elementsInRow", {
        get: /**
         * @return {?}
         */
        function () {
            return this._gridSize.width;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?} width
     * @param {?} height
     * @param {?} gameSpeed
     * @param {?=} tileSize
     * @return {?}
     */
    GameManagerService.prototype.initialize = /**
     * @param {?} width
     * @param {?} height
     * @param {?} gameSpeed
     * @param {?=} tileSize
     * @return {?}
     */
    function (width, height, gameSpeed, tileSize) {
        this._gridSize.width = width;
        this._gridSize.height = height;
        this._gameSpeed = gameSpeed;
        this._piecesFactory = new PiecesFactory(this._gridSize);
        if (tileSize) {
            this.settings.tileSize = tileSize;
        }
        this._initializeEmptyBoard();
        this._spawnNewPiece();
        this._drawPiece();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype.start = /**
     * @return {?}
     */
    function () {
        var _this = this;
        clearInterval(this._gameInterval);
        this._gameInterval = setInterval(function () {
            _this._update();
        }, this._gameSpeed);
        this._locked = false;
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype.stop = /**
     * @return {?}
     */
    function () {
        this._locked = true;
        clearInterval(this._gameInterval);
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype.reset = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var emptyTile = new Tile();
        for (var pos = 0; pos < this.grid.length; pos++) {
            if (this.grid[pos].color || this.grid[pos].solid) {
                this.__changeCell(pos, emptyTile);
            }
        }
        this._spawnNewPiece();
        this._drawPiece();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype.moveLeft = /**
     * @return {?}
     */
    function () {
        if (this._locked) {
            return;
        }
        this._clearPiece();
        this._piece.store();
        this._piece.moveLeft();
        if (this._collidesLeft()) {
            this._piece.revert();
        }
        this._drawPiece();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype.moveRight = /**
     * @return {?}
     */
    function () {
        if (this._locked) {
            return;
        }
        this._clearPiece();
        this._piece.store();
        this._piece.moveRight();
        if (this._collidesRight()) {
            this._piece.revert();
        }
        this._drawPiece();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype.rotate = /**
     * @return {?}
     */
    function () {
        if (this._locked) {
            return;
        }
        this._clearPiece();
        this._piece.store();
        this._piece.rotate();
        while (this._collidesRight()) {
            this._piece.moveLeft();
            if (this._collidesLeft()) {
                this._piece.revert();
                break;
            }
        }
        this._drawPiece();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype.moveDown = /**
     * @return {?}
     */
    function () {
        this._update();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._clearFullLines = /**
     * @return {?}
     */
    function () {
        for (var row = this._gridSize.height - 1; row >= 0; row--) {
            /** @type {?} */
            var isFull = true;
            for (var col = 0; col < this._gridSize.width; col++) {
                /** @type {?} */
                var pos = row * this._gridSize.width + col;
                if (this.grid[pos].solid === false) {
                    isFull = false;
                    break;
                }
            }
            if (isFull) {
                /** @type {?} */
                var emptyRow = Array.apply(null, Array(this._gridSize.width))
                    .map(function (idx) { return new Tile(); });
                /** @type {?} */
                var topPortion = this.grid.slice(0, row * this._gridSize.width);
                (_a = this.grid).splice.apply(_a, tslib_1.__spread([0, ++row * this._gridSize.width], emptyRow.concat(topPortion)));
                this._lineCleared.next();
            }
        }
        var _a;
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._update = /**
     * @return {?}
     */
    function () {
        if (this._locked) {
            return;
        }
        this._locked = true;
        this._piece.revert();
        this._clearPiece();
        this._piece.store();
        this._piece.moveDown();
        if (this._collidesBottom()) {
            this._piece.revert();
            this._markSolid();
            this._drawPiece();
            this._clearFullLines();
            this._spawnNewPiece();
            if (this._isGameOver()) {
                this._onGameOver();
                return;
            }
        }
        this._drawPiece();
        this._locked = false;
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._isGameOver = /**
     * @return {?}
     */
    function () {
        this._piece.store();
        this._piece.moveDown();
        if (this._collidesBottom()) {
            return true;
        }
        this._piece.revert();
        return false;
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._onGameOver = /**
     * @return {?}
     */
    function () {
        this.stop();
        this._gameOver.next();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._spawnNewPiece = /**
     * @return {?}
     */
    function () {
        this._piece = this._piecesFactory.getRandomPiecePiece(SPAWN_POSITION_X, SPAWN_POSITION_Y);
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._initializeEmptyBoard = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var cellsCount = this._gridSize.width * this._gridSize.height;
        this.grid = Array.apply(null, Array(cellsCount))
            .map(function (idx) { return new Tile(); });
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._clearPiece = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this._piece.positionsOnGrid
            .forEach(function (pos) {
            _this.__changeCell(pos, { color: undefined });
        });
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._drawPiece = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this._piece.clearStore();
        this._piece.positionsOnGrid
            .forEach(function (pos) {
            _this.__changeCell(pos, { color: _this._piece.color });
        });
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._markSolid = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this._piece.positionsOnGrid.forEach(function (pos) {
            _this.__changeCell(pos, { solid: true });
        });
    };
    /**
     * @param {?} pos
     * @param {?=} data
     * @return {?}
     */
    GameManagerService.prototype.__changeCell = /**
     * @param {?} pos
     * @param {?=} data
     * @return {?}
     */
    function (pos, data) {
        if (data === void 0) { data = {}; }
        this.grid[pos] = Object.assign({}, this.grid[pos], data);
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._collidesBottom = /**
     * @return {?}
     */
    function () {
        if (this._piece.bottomRow >= this._gridSize.height) {
            return true;
        }
        return this.__collides();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._collidesLeft = /**
     * @return {?}
     */
    function () {
        if (this._piece.leftCol < 0) {
            return true;
        }
        return this.__collides();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype._collidesRight = /**
     * @return {?}
     */
    function () {
        if (this._piece.rightCol >= this._gridSize.width) {
            return true;
        }
        return this.__collides();
    };
    /**
     * @return {?}
     */
    GameManagerService.prototype.__collides = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return this._piece.positionsOnGrid
            .some(function (pos) {
            if (pos > 0 && _this.grid[pos] && _this.grid[pos].solid) {
                return true;
            }
            return false;
        });
    };
    GameManagerService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    GameManagerService.ctorParameters = function () { return []; };
    return GameManagerService;
}());
export { GameManagerService };
if (false) {
    /** @type {?} */
    GameManagerService.prototype.settings;
    /** @type {?} */
    GameManagerService.prototype.grid;
    /** @type {?} */
    GameManagerService.prototype.lineCleared$;
    /** @type {?} */
    GameManagerService.prototype.gameOver$;
    /** @type {?} */
    GameManagerService.prototype._gridSize;
    /** @type {?} */
    GameManagerService.prototype._piece;
    /** @type {?} */
    GameManagerService.prototype._piecesFactory;
    /** @type {?} */
    GameManagerService.prototype._locked;
    /** @type {?} */
    GameManagerService.prototype._gameSpeed;
    /** @type {?} */
    GameManagerService.prototype._gameInterval;
    /** @type {?} */
    GameManagerService.prototype._lineCleared;
    /** @type {?} */
    GameManagerService.prototype._gameOver;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZS1tYW5hZ2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdGV0cmlzLyIsInNvdXJjZXMiOlsic2VydmljZXMvZ2FtZS1tYW5hZ2VyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBRXpDLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUV2RCxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sdUJBQXVCLENBQUM7O0FBRTlDLElBQU0sZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDOztBQUMzQixJQUFNLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxDQUFDO0FBRTVCLElBQUE7O3FCQUNZLEtBQUs7cUJBQ0wsSUFBSTs7ZUFYaEI7SUFZQyxDQUFBO0FBSEQsZ0JBR0M7Ozs7Ozs7O0lBaUNHO3dCQTdCa0I7WUFDZCxRQUFRLEVBQUUsSUFBSTtTQUNqQjt5QkFlRyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRTt1QkFLVCxJQUFJOzRCQUlDLElBQUksT0FBTyxFQUFPO3lCQUNyQixJQUFJLE9BQU8sRUFBTztRQUdsQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDckQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDO0tBQ2xEOzBCQTVCVSw2Q0FBYTs7Ozs7WUFDcEIsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDOzs7Ozs7Ozs7Ozs7SUE2QnpCLHVDQUFVOzs7Ozs7O2NBQUMsS0FBYSxFQUFFLE1BQWMsRUFBRSxTQUFTLEVBQUUsUUFBYztRQUN0RSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDN0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxN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LENBQUM7U0FDZjtRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Ozs7O0lBR3JCLDBDQUFhOzs7O1FBQ2pCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUIsTUFBTSxDQUFDLElBQUksQ0FBQztTQUNmO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzs7Ozs7SUFHckIsMkNBQWM7Ozs7UUFDbEIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxJQUFJLENBQUM7U0FDZjtRQUVELE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Ozs7O0lBR3JCLHVDQUFVOzs7OztRQUNkLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWU7YUFDN0IsSUFBSSxDQUFDLFVBQUMsR0FBRztZQUNOLEVBQUUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLElBQUksS0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQ3BELE1BQU0sQ0FBQyxJQUFJLENBQUM7YUFDZjtZQUVELE1BQU0sQ0FBQyxLQUFLLENBQUM7U0FDaEIsQ0FBQyxDQUFDOzs7Z0JBMVFkLFVBQVU7Ozs7NkJBZFg7O1NBZWEsa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7UGllY2V9IGZyb20gJy4uL2NsYXNzZXMvUGllY2UnO1xuaW1wb3J0IHtQaWVjZXNGYWN0b3J5fSBmcm9tICcuLi9jbGFzc2VzL1BpZWNlc0ZhY3RvcnknO1xuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzL2ludGVybmFsL09ic2VydmFibGUnO1xuaW1wb3J0IHtTdWJqZWN0fSBmcm9tICdyeGpzL2ludGVybmFsL1N1YmplY3QnO1xuXG5jb25zdCBTUEFXTl9QT1NJVElPTl9YID0gNDtcbmNvbnN0IFNQQVdOX1BPU0lUSU9OX1kgPSAtNDtcblxuZXhwb3J0IGNsYXNzIFRpbGUge1xuICAgIHNvbGlkID0gZmFsc2U7XG4gICAgY29sb3IgPSBudWxsO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgR2FtZU1hbmFnZXJTZXJ2aWNlIHtcbiAgICBwdWJsaWMgc2V0dGluZ3MgPSB7XG4gICAgICAgIHRpbGVTaXplOiBudWxsXG4gICAgfTtcblxuICAgIHB1YmxpYyBnZXQgZWxlbWVudHNJblJvdygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dyaWRTaXplLndpZHRoO1xuICAgIH1cblxuICAgIC8vIHNlcmlhbGl6ZWQgZ3JpZCA6KVxuICAgIHB1YmxpYyBncmlkOiBBcnJheTxUaWxlPjtcblxuICAgIHB1YmxpYyBsaW5lQ2xlYXJlZCQ6IE9ic2VydmFibGU8YW55PjtcbiAgICBwdWJsaWMgZ2FtZU92ZXIkOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgICBwcml2YXRlIF9ncmlkU2l6ZToge1xuICAgICAgICB3aWR0aDogbnVtYmVyLFxuICAgICAgICBoZWlnaHQ6IG51bWJlclxuICAgIH0gPSB7IHdpZHRoOiAwLCBoZWlnaHQ6IDAgfTtcblxuICAgIHByaXZhdGUgX3BpZWNlOiBQaWVjZTtcbiAgICBwcml2YXRlIF9waWVjZXNGYWN0b3J5OiBQaWVjZXNGYWN0b3J5O1xuXG4gICAgcHJpdmF0ZSBfbG9ja2VkID0gdHJ1ZTtcbiAgICBwcml2YXRlIF9nYW1lU3BlZWQ6IG51bWJlcjtcbiAgICBwcml2YXRlIF9nYW1lSW50ZXJ2YWw7XG5cbiAgICBwcml2YXRlIF9saW5lQ2xlYXJlZCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICBwcml2YXRlIF9nYW1lT3ZlciA9IG5ldyBTdWJqZWN0PGFueT4oKTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLmxpbmVDbGVhcmVkJCA9IHRoaXMuX2xpbmVDbGVhcmVkLmFzT2JzZXJ2YWJsZSgpO1xuICAgICAgICB0aGlzLmdhbWVPdmVyJCA9IHRoaXMuX2dhbWVPdmVyLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbml0aWFsaXplKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCBnYW1lU3BlZWQsIHRpbGVTaXplPzogYW55KSB7XG4gICAgICAgIHRoaXMuX2dyaWRTaXplLndpZHRoID0gd2lkdGg7XG4gICAgICAgIHRoaXMuX2dyaWRTaXplLmhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgdGhpcy5fZ2FtZVNwZWVkID0gZ2FtZVNwZWVkO1xuICAgICAgICB0aGlzLl9waWVjZXNGYWN0b3J5ID0gbmV3IFBpZWNlc0ZhY3RvcnkodGhpcy5fZ3JpZFNpemUpO1xuXG4gICAgICAgIGlmICh0aWxlU2l6ZSkge1xuICAgICAgICAgICAgdGhpcy5zZXR0aW5ncy50aWxlU2l6ZSA9IHRpbGVTaXplO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZUVtcHR5Qm9hcmQoKTtcblxuICAgICAgICB0aGlzLl9zcGF3bk5ld1BpZWNlKCk7XG4gICAgICAgIHRoaXMuX2RyYXdQaWVjZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGFydCgpIHtcbiAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9nYW1lSW50ZXJ2YWwpO1xuICAgICAgICB0aGlzLl9nYW1lSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl91cGRhdGUoKTtcbiAgICAgICAgfSwgdGhpcy5fZ2FtZVNwZWVkKTtcbiAgICAgICAgdGhpcy5fbG9ja2VkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcHVibGljIHN0b3AoKSB7XG4gICAgICAgIHRoaXMuX2xvY2tlZCA9IHRydWU7XG4gICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fZ2FtZUludGVydmFsKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVzZXQoKSB7XG4gICAgICAgIGNvbnN0IGVtcHR5VGlsZSA9IG5ldyBUaWxlKCk7XG4gICAgICAgIGZvciAobGV0IHBvcyA9IDA7IHBvcyA8IHRoaXMuZ3JpZC5sZW5ndGg7IHBvcysrKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5ncmlkW3Bvc10uY29sb3IgfHwgdGhpcy5ncmlkW3Bvc10uc29saWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9fY2hhbmdlQ2VsbChwb3MsIGVtcHR5VGlsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9zcGF3bk5ld1BpZWNlKCk7XG4gICAgICAgIHRoaXMuX2RyYXdQaWVjZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBtb3ZlTGVmdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2xvY2tlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2NsZWFyUGllY2UoKTtcbiAgICAgICAgdGhpcy5fcGllY2Uuc3RvcmUoKTtcblxuICAgICAgICB0aGlzLl9waWVjZS5tb3ZlTGVmdCgpO1xuICAgICAgICBpZiAodGhpcy5fY29sbGlkZXNMZWZ0KCkpIHtcbiAgICAgICAgICAgIHRoaXMuX3BpZWNlLnJldmVydCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fZHJhd1BpZWNlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIG1vdmVSaWdodCgpIHtcbiAgICAgICAgaWYgKHRoaXMuX2xvY2tlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2NsZWFyUGllY2UoKTtcbiAgICAgICAgdGhpcy5fcGllY2Uuc3RvcmUoKTtcblxuICAgICAgICB0aGlzLl9waWVjZS5tb3ZlUmlnaHQoKTtcbiAgICAgICAgaWYgKHRoaXMuX2NvbGxpZGVzUmlnaHQoKSkge1xuICAgICAgICAgICAgdGhpcy5fcGllY2UucmV2ZXJ0KCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9kcmF3UGllY2UoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcm90YXRlKCkge1xuICAgICAgICBpZiAodGhpcy5fbG9ja2VkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9jbGVhclBpZWNlKCk7XG4gICAgICAgIHRoaXMuX3BpZWNlLnN0b3JlKCk7XG5cbiAgICAgICAgdGhpcy5fcGllY2Uucm90YXRlKCk7XG4gICAgICAgIHdoaWxlICh0aGlzLl9jb2xsaWRlc1JpZ2h0KCkpIHtcbiAgICAgICAgICAgIHRoaXMuX3BpZWNlLm1vdmVMZWZ0KCk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLl9jb2xsaWRlc0xlZnQoKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3BpZWNlLnJldmVydCgpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fZHJhd1BpZWNlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIG1vdmVEb3duKCkge1xuICAgICAgICB0aGlzLl91cGRhdGUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jbGVhckZ1bGxMaW5lcygpIHtcbiAgICAgICAgZm9yIChsZXQgcm93ID0gdGhpcy5fZ3JpZFNpemUuaGVpZ2h0IC0gMTsgcm93ID49IDA7IHJvdy0tKSB7XG4gICAgICAgICAgICBsZXQgaXNGdWxsID0gdHJ1ZTtcbiAgICAgICAgICAgIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IHRoaXMuX2dyaWRTaXplLndpZHRoOyBjb2wrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHJvdyAqIHRoaXMuX2dyaWRTaXplLndpZHRoICsgY29sO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmdyaWRbcG9zXS5zb2xpZCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNGdWxsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGlzRnVsbCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVtcHR5Um93ID0gQXJyYXkuYXBwbHkobnVsbCwgQXJyYXkodGhpcy5fZ3JpZFNpemUud2lkdGgpKVxuICAgICAgICAgICAgICAgICAgICAubWFwKChpZHgpID0+IG5ldyBUaWxlKCkpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgdG9wUG9ydGlvbiA9IHRoaXMuZ3JpZC5zbGljZSgwLCByb3cgKiB0aGlzLl9ncmlkU2l6ZS53aWR0aCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmdyaWQuc3BsaWNlKDAsICsrcm93ICogdGhpcy5fZ3JpZFNpemUud2lkdGgsIC4uLmVtcHR5Um93LmNvbmNhdCh0b3BQb3J0aW9uKSk7XG4gICAgICAgICAgICAgICAgdGhpcy5fbGluZUNsZWFyZWQubmV4dCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfdXBkYXRlKCkge1xuICAgICAgICBpZiAodGhpcy5fbG9ja2VkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fbG9ja2VkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5fcGllY2UucmV2ZXJ0KCk7XG5cbiAgICAgICAgdGhpcy5fY2xlYXJQaWVjZSgpO1xuICAgICAgICB0aGlzLl9waWVjZS5zdG9yZSgpO1xuXG4gICAgICAgIHRoaXMuX3BpZWNlLm1vdmVEb3duKCk7XG4gICAgICAgIGlmICh0aGlzLl9jb2xsaWRlc0JvdHRvbSgpKSB7XG4gICAgICAgICAgICB0aGlzLl9waWVjZS5yZXZlcnQoKTtcbiAgICAgICAgICAgIHRoaXMuX21hcmtTb2xpZCgpO1xuICAgICAgICAgICAgdGhpcy5fZHJhd1BpZWNlKCk7XG5cbiAgICAgICAgICAgIHRoaXMuX2NsZWFyRnVsbExpbmVzKCk7XG5cbiAgICAgICAgICAgIHRoaXMuX3NwYXduTmV3UGllY2UoKTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9pc0dhbWVPdmVyKCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9vbkdhbWVPdmVyKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fZHJhd1BpZWNlKCk7XG4gICAgICAgIHRoaXMuX2xvY2tlZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2lzR2FtZU92ZXIoKSB7XG4gICAgICAgIHRoaXMuX3BpZWNlLnN0b3JlKCk7XG4gICAgICAgIHRoaXMuX3BpZWNlLm1vdmVEb3duKCk7XG4gICAgICAgIGlmICh0aGlzLl9jb2xsaWRlc0JvdHRvbSgpKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3BpZWNlLnJldmVydCgpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfb25HYW1lT3ZlcigpIHtcbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgIHRoaXMuX2dhbWVPdmVyLm5leHQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9zcGF3bk5ld1BpZWNlKCkge1xuICAgICAgICB0aGlzLl9waWVjZSA9IHRoaXMuX3BpZWNlc0ZhY3RvcnkuZ2V0UmFuZG9tUGllY2VQaWVjZShTUEFXTl9QT1NJVElPTl9YLCBTUEFXTl9QT1NJVElPTl9ZKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9pbml0aWFsaXplRW1wdHlCb2FyZCgpIHtcbiAgICAgICAgY29uc3QgY2VsbHNDb3VudCA9IHRoaXMuX2dyaWRTaXplLndpZHRoICogdGhpcy5fZ3JpZFNpemUuaGVpZ2h0O1xuICAgICAgICB0aGlzLmdyaWQgPSBBcnJheS5hcHBseShudWxsLCBBcnJheShjZWxsc0NvdW50KSlcbiAgICAgICAgICAgIC5tYXAoKGlkeCkgPT4gbmV3IFRpbGUoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY2xlYXJQaWVjZSgpIHtcbiAgICAgICAgdGhpcy5fcGllY2UucG9zaXRpb25zT25HcmlkXG4gICAgICAgICAgICAuZm9yRWFjaCgocG9zKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fX2NoYW5nZUNlbGwocG9zLCB7Y29sb3I6IHVuZGVmaW5lZH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZHJhd1BpZWNlKCkge1xuICAgICAgICB0aGlzLl9waWVjZS5jbGVhclN0b3JlKCk7XG4gICAgICAgIHRoaXMuX3BpZWNlLnBvc2l0aW9uc09uR3JpZFxuICAgICAgICAgICAgLmZvckVhY2goKHBvcykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX19jaGFuZ2VDZWxsKHBvcywge2NvbG9yOiB0aGlzLl9waWVjZS5jb2xvcn0pO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfbWFya1NvbGlkKCkge1xuICAgICAgICB0aGlzLl9waWVjZS5wb3NpdGlvbnNPbkdyaWQuZm9yRWFjaCgocG9zKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9fY2hhbmdlQ2VsbChwb3MsIHtzb2xpZDogdHJ1ZX0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9fY2hhbmdlQ2VsbChwb3MsIGRhdGEgPSB7fSkge1xuICAgICAgICB0aGlzLmdyaWRbcG9zXSA9IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuZ3JpZFtwb3NdLCBkYXRhKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jb2xsaWRlc0JvdHRvbSgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3BpZWNlLmJvdHRvbVJvdyA+PSB0aGlzLl9ncmlkU2l6ZS5oZWlnaHQpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9fY29sbGlkZXMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9jb2xsaWRlc0xlZnQoKSB7XG4gICAgICAgIGlmICh0aGlzLl9waWVjZS5sZWZ0Q29sIDwgMCkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fX2NvbGxpZGVzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfY29sbGlkZXNSaWdodCgpIHtcbiAgICAgICAgaWYgKHRoaXMuX3BpZWNlLnJpZ2h0Q29sID49IHRoaXMuX2dyaWRTaXplLndpZHRoKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9fY29sbGlkZXMoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9fY29sbGlkZXMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9waWVjZS5wb3NpdGlvbnNPbkdyaWRcbiAgICAgICAgICAgIC5zb21lKChwb3MpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocG9zID4gMCAmJiB0aGlzLmdyaWRbcG9zXSAmJiB0aGlzLmdyaWRbcG9zXS5zb2xpZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=